<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opulence | Gestion Restaurant Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0F0F11;
            color: #E4E4E7;
            overflow-x: hidden;
        }
        .glass {
            background: rgba(26, 26, 29, 0.85);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(225, 29, 72, 0.15) 0%, transparent 100%);
            border-left: 4px solid #E11D48;
            color: white;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #27272A;
            border-radius: 10px;
        }
        .product-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .product-card:hover {
            transform: translateY(-5px);
            border-color: rgba(225, 29, 72, 0.3);
        }
        .inventory-bar {
            height: 6px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        .inventory-bar.low {
            background: linear-gradient(90deg, #EF4444 0%, #DC2626 100%);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }
        .inventory-bar.medium {
            background: linear-gradient(90deg, #F59E0B 0%, #D97706 100%);
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
        }
        .inventory-bar.high {
            background: linear-gradient(90deg, #10B981 0%, #059669 100%);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
        }
        .popup-overlay {
            animation: fadeIn 0.2s ease-out;
        }
        .popup-container {
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @media (max-width: 1024px) {
            .mobile-sidebar-hidden { transform: translateX(-100%); }
            .mobile-sidebar-show { transform: translateX(0); }
        }
    </style>
</head>
<body class="custom-scrollbar">

<div id="app">
    <!-- MODAL POPUP -->
    <div id="popup-modal" class="fixed inset-0 z-[9999] hidden items-center justify-center popup-overlay">
        <div class="absolute inset-0 bg-black/70" onclick="hidePopup()"></div>
        <div class="relative glass rounded-[2.5rem] p-8 max-w-md w-full mx-4 popup-container">
            <div class="text-center mb-6">
                <div id="popup-icon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <!-- Icon will be set dynamically -->
                </div>
                <h3 id="popup-title" class="text-2xl font-bold text-white mb-2"></h3>
                <p id="popup-message" class="text-zinc-400"></p>
            </div>
            <div class="flex space-x-4">
                <button onclick="hidePopup()" id="popup-cancel" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-3 rounded-2xl transition-all">Annuler</button>
                <button onclick="popupConfirmAction()" id="popup-confirm" class="flex-1 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 rounded-2xl transition-all">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- MODAL FORMULAIRE PRODUIT -->
    <div id="product-form-modal" class="fixed inset-0 z-[10000] hidden items-center justify-center popup-overlay">
        <div class="absolute inset-0 bg-black/70" onclick="hideProductForm()"></div>
        <div class="relative glass rounded-[2.5rem] p-8 max-w-2xl w-full mx-4 popup-container max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h3 id="product-form-title" class="text-2xl font-bold text-white">Nouveau Produit</h3>
                <button onclick="hideProductForm()" class="text-zinc-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="product-form" class="space-y-6">
                <input type="hidden" id="product-edit-id" value="">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-zinc-400 mb-2">Nom du produit *</label>
                        <input type="text" id="product-name" required class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all placeholder-zinc-700" placeholder="Ex: Malangua">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-zinc-400 mb-2">Catégorie *</label>
                        <select id="product-type" required class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all">
                            <option value="repas">Plat principal</option>
                            <option value="boisson">Boisson</option>
                            <option value="dessert">Dessert</option>
                            <option value="entree">Entrée</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-zinc-400 mb-2">Prix (€) *</label>
                        <input type="number" id="product-price" step="0.01" min="0" required class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all" placeholder="0.00">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-zinc-400 mb-2">Stock actuel</label>
                        <input type="number" id="product-stock" min="0" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all" placeholder="0">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-zinc-400 mb-2">Stock maximum</label>
                        <input type="number" id="product-stock-max" min="1" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all" placeholder="100">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-zinc-400 mb-2">Description</label>
                    <textarea id="product-desc" rows="3" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all placeholder-zinc-700" placeholder="Description du produit..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-zinc-400 mb-2">URL de l'image</label>
                    <input type="text" id="product-image" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all placeholder-zinc-700" placeholder="https://exemple.com/image.jpg">
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="hideProductForm()" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-4 rounded-2xl transition-all">Annuler</button>
                    <button type="submit" class="flex-1 bg-rose-600 hover:bg-rose-700 text-white font-bold py-4 rounded-2xl transition-all">
                        <i class="fas fa-save mr-2"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL GESTION STOCK -->
    <div id="stock-modal" class="fixed inset-0 z-[10000] hidden items-center justify-center popup-overlay">
        <div class="absolute inset-0 bg-black/70" onclick="hideStockModal()"></div>
        <div class="relative glass rounded-[2.5rem] p-8 max-w-md w-full mx-4 popup-container">
            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-blue-500/20 text-blue-500">
                    <i class="fas fa-boxes text-2xl"></i>
                </div>
                <h3 id="stock-title" class="text-2xl font-bold text-white mb-2"></h3>
                <p id="stock-product-name" class="text-zinc-400 font-bold"></p>
            </div>
            
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p class="text-zinc-400 text-sm mb-2">Stock actuel</p>
                        <p id="current-stock" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-zinc-400 text-sm mb-2">Stock maximum</p>
                        <p id="max-stock" class="text-3xl font-bold text-white">0</p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-zinc-400 mb-2">Modifier le stock</label>
                    <div class="flex space-x-2">
                        <button onclick="adjustStock(-10)" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-3 rounded-2xl">
                            -10
                        </button>
                        <button onclick="adjustStock(-5)" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-3 rounded-2xl">
                            -5
                        </button>
                        <button onclick="adjustStock(-1)" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-3 rounded-2xl">
                            -1
                        </button>
                        <input type="number" id="stock-input" value="0" class="w-20 bg-zinc-900/80 border border-zinc-800 rounded-2xl py-3 px-4 text-center text-white">
                        <button onclick="adjustStock(1)" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-3 rounded-2xl">
                            +1
                        </button>
                        <button onclick="adjustStock(5)" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-3 rounded-2xl">
                            +5
                        </button>
                        <button onclick="adjustStock(10)" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-3 rounded-2xl">
                            +10
                        </button>
                    </div>
                    <p class="text-xs text-zinc-500 mt-2">Cliquez sur les boutons ou entrez une valeur manuelle</p>
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button onclick="hideStockModal()" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-4 rounded-2xl transition-all">Annuler</button>
                    <button onclick="saveStockChanges()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl transition-all">
                        <i class="fas fa-check mr-2"></i> Appliquer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION TOAST -->
    <div id="toast" class="fixed top-6 right-6 z-[9998] glass p-4 rounded-2xl shadow-2xl transform translate-x-full transition-transform duration-300">
        <div class="flex items-center">
            <div id="toast-icon" class="w-10 h-10 rounded-full flex items-center justify-center mr-3">
                <!-- Icon set dynamically -->
            </div>
            <div>
                <p id="toast-title" class="font-bold text-white text-sm"></p>
                <p id="toast-message" class="text-zinc-400 text-xs"></p>
            </div>
        </div>
    </div>

    <!-- ECRAN DE CONNEXION/INSCRIPTION -->
    <div id="auth-screen" class="min-h-screen w-full flex items-center justify-center relative transition-opacity duration-500">
        <div class="absolute inset-0 z-0">
            <img src="https://images.unsplash.com/photo-1555396273-367ea4eb4db5?auto=format&fit=crop&w=1920&q=80" class="w-full h-full object-cover opacity-20" alt="Restaurant Background">
            <div class="absolute inset-0 bg-gradient-to-b from-black/80 to-[#0F0F11]"></div>
        </div>
        
        <div class="relative z-10 w-full max-w-md p-8 glass rounded-[2.5rem] shadow-2xl mx-4">
            <div class="text-center mb-10">
                <div class="w-20 h-20 bg-rose-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl shadow-rose-600/40">
                    <span class="text-4xl font-bold italic text-white">O</span>
                </div>
                <h1 class="text-4xl font-extrabold tracking-tight text-white">Opulence</h1>
                <p class="text-zinc-500 mt-2 font-medium">Gestion & Commande de Luxe</p>
            </div>

            <!-- Onglets Auth -->
            <div class="flex mb-6 border-b border-zinc-800">
                <button id="login-tab" onclick="switchAuthTab('login')" class="flex-1 py-3 font-bold text-white border-b-2 border-rose-600">Connexion</button>
                <button id="register-tab" onclick="switchAuthTab('register')" class="flex-1 py-3 font-bold text-zinc-500">Inscription</button>
            </div>

            <!-- Formulaire Connexion -->
            <form id="login-form" onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-zinc-400 mb-2">Mode d'accès</label>
                    <select id="login-role" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all" onchange="toggleLoginFields()">
                        <option value="visitor">Visiteur</option>
                        <option value="admin">Administrateur</option>
                    </select>
                </div>

                <div id="visitor-login-fields">
                    <div>
                        <label class="block text-sm font-semibold text-zinc-400 mb-2">Numéro de téléphone</label>
                        <input type="tel" id="login-phone" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all" placeholder="+243 XX XX XX XX">
                    </div>
                </div>

                <div id="admin-login-fields" class="hidden">
                    <div>
                        <label class="block text-sm font-semibold text-zinc-400 mb-2">Nom d'utilisateur</label>
                        <input type="text" id="admin-username" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all" placeholder="gt">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-zinc-400 mb-2">Mot de passe</label>
                        <input type="password" id="admin-password" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all" placeholder="55436">
                    </div>
                </div>

                <button type="submit" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-rose-600/20 transform transition active:scale-95">
                    <i class="fas fa-door-open mr-2"></i> Entrer dans l'établissement
                </button>
            </form>

            <!-- Formulaire Inscription -->
            <form id="register-form" onsubmit="handleRegister(event)" class="space-y-6 hidden">
                <div>
                    <label class="block text-sm font-semibold text-zinc-400 mb-2">Nom complet *</label>
                    <input type="text" id="register-name" required class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all" placeholder="Votre nom">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-zinc-400 mb-2">Numéro de téléphone *</label>
                    <input type="tel" id="register-phone" required class="w-full bg-zinc-900/80 border border-zinc-800 rounded-2xl py-4 px-5 focus:outline-none focus:border-rose-600 text-white transition-all" placeholder="+243 XX XX XX XX">
                </div>

                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-600/20 transform transition active:scale-95">
                    <i class="fas fa-user-plus mr-2"></i> S'inscrire
                </button>
            </form>

            <div class="mt-8 text-center">
                <p class="text-zinc-500 text-xs font-medium uppercase tracking-widest">Accès rapide</p>
                <div class="flex justify-center gap-4 mt-3">
                    <button onclick="quickFill('admin')" class="text-[10px] bg-zinc-800 hover:bg-zinc-700 px-3 py-1 rounded-full text-zinc-400">
                        <i class="fas fa-user-shield mr-1"></i> Mode Admin
                    </button>
                    <button onclick="quickFill('visitor')" class="text-[10px] bg-zinc-800 hover:bg-zinc-700 px-3 py-1 rounded-full text-zinc-400">
                        <i class="fas fa-user mr-1"></i> Mode Visiteur
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- INTERFACE PRINCIPALE -->
    <div id="main-layout" class="hidden h-screen flex flex-col lg:flex-row overflow-hidden">
        
        <!-- Sidebar Mobile Overlay -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 lg:hidden hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:relative inset-y-0 left-0 w-72 glass border-r border-zinc-800 flex flex-col z-50 transition-transform duration-300 mobile-sidebar-hidden lg:translate-x-0">
            <div class="p-8 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-rose-600 rounded-full flex items-center justify-center font-bold italic text-white">O</div>
                    <span class="text-xl font-bold tracking-tighter text-white">OPULENCE</span>
                </div>
                <button onclick="toggleSidebar()" class="lg:hidden text-zinc-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <nav id="nav-menu" class="flex-1 px-4 space-y-2 mt-4 overflow-y-auto custom-scrollbar">
                <!-- Dynamique via JS -->
            </nav>

            <div class="p-6 border-t border-zinc-800">
                <div class="flex items-center justify-between group cursor-pointer" onclick="logout()">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-xl bg-rose-600/10 flex items-center justify-center text-rose-500 group-hover:bg-rose-600 group-hover:text-white transition-all">
                            <i class="fas fa-sign-out-alt"></i>
                        </div>
                        <span class="font-bold text-sm text-zinc-400 group-hover:text-white">Déconnexion</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="h-20 flex items-center justify-between px-6 lg:px-10 bg-[#0F0F11]/90 backdrop-blur-md border-b border-zinc-900 shrink-0 z-30">
                <div class="flex items-center space-x-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 bg-zinc-900 rounded-xl text-zinc-400">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 id="page-title" class="text-xl lg:text-2xl font-bold text-white">Menu</h2>
                </div>
                
                <div class="flex items-center space-x-4 lg:space-x-8">
                    <div class="hidden sm:block relative">
                        <input type="text" onkeyup="searchItems(this.value)" placeholder="Rechercher..." class="bg-zinc-900/50 border border-zinc-800 rounded-2xl py-2 px-10 text-sm focus:outline-none focus:border-rose-600 w-48 lg:w-64 transition-all">
                        <i class="fas fa-search absolute left-3 top-2.5 text-zinc-600"></i>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <div class="hidden md:block text-right leading-none">
                            <p id="user-display-name" class="text-sm font-bold text-white">Visiteur</p>
                            <span id="user-role-label" class="text-[9px] text-zinc-500 uppercase tracking-widest font-bold">Client</span>
                        </div>
                        <div class="w-11 h-11 rounded-2xl bg-zinc-900 border border-zinc-800 overflow-hidden shadow-inner">
                            <img id="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="Avatar">
                        </div>
                    </div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div id="content-display" class="flex-1 overflow-y-auto p-6 lg:p-10 custom-scrollbar relative bg-[#0F0F11]">
                <!-- Contenu via JS -->
            </div>
        </main>

        <!-- Right Panel (Cart or Stats) -->
        <aside id="right-panel" class="hidden xl:flex w-80 glass border-l border-zinc-800 p-8 flex flex-col shrink-0">
            <!-- Contenu via JS -->
        </aside>

        <!-- Mobile Cart FAB (Only for visitor) -->
        <button id="mobile-cart-btn" onclick="toggleMobileCart()" class="fixed bottom-6 right-6 w-16 h-16 bg-rose-600 rounded-full shadow-2xl shadow-rose-600/40 flex items-center justify-center z-40 lg:hidden hidden text-white">
            <i class="fas fa-shopping-cart text-xl"></i>
            <span id="cart-count-badge" class="absolute -top-1 -right-1 bg-white text-rose-600 text-[10px] font-black w-6 h-6 rounded-full flex items-center justify-center border-2 border-rose-600">0</span>
        </button>
    </div>

    <!-- Mobile Cart Drawer -->
    <div id="mobile-cart-drawer" class="fixed inset-0 z-[100] translate-x-full transition-transform duration-300 lg:hidden">
        <div class="absolute inset-0 bg-black/60" onclick="toggleMobileCart()"></div>
        <div class="absolute right-0 top-0 bottom-0 w-[85%] max-w-sm glass flex flex-col p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-xl font-bold text-white">Votre Panier</h3>
                <button onclick="toggleMobileCart()" class="text-zinc-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="mobile-cart-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-4"></div>
            <div id="mobile-cart-footer" class="pt-6 border-t border-zinc-800 mt-4"></div>
        </div>
    </div>
</div>

<script>
    // ============================================
    // VARIABLES GLOBALES ET ETAT DE L'APPLICATION
    // ============================================
    let currentUser = null;
    let currentTab = 'home';
    let cart = [];
    let currentCategory = 'all';
    let searchQuery = '';
    let popupCallback = null;
    let popupData = null;
    let visitorOrders = [];
    let currentStockProductId = null;
    let inventoryFilter = 'all';

    // API Base URL
    const API_BASE_URL = window.location.hostname === 'localhost' 
        ? 'http://localhost:3000/api' 
        : '/api';

    // Catégories disponibles
    const categories = [
        { id: 'all', name: 'Tous', icon: 'fas fa-layer-group' },
        { id: 'repas', name: 'Plats', icon: 'fas fa-utensils' },
        { id: 'boisson', name: 'Boissons', icon: 'fas fa-wine-glass' },
        { id: 'dessert', name: 'Desserts', icon: 'fas fa-ice-cream' },
        { id: 'entree', name: 'Entrées', icon: 'fas fa-carrot' }
    ];

    // Données du menu
    let menuData = [];

    // Commandes
    let orders = [];

    // ============================================
    // FONCTIONS D'AUTHENTIFICATION
    // ============================================
    function switchAuthTab(tab) {
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');

        if (tab === 'login') {
            loginTab.classList.add('text-white', 'border-rose-600');
            loginTab.classList.remove('text-zinc-500');
            registerTab.classList.add('text-zinc-500');
            registerTab.classList.remove('text-white', 'border-rose-600');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        } else {
            registerTab.classList.add('text-white', 'border-rose-600');
            registerTab.classList.remove('text-zinc-500');
            loginTab.classList.add('text-zinc-500');
            loginTab.classList.remove('text-white', 'border-rose-600');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        }
    }

    function toggleLoginFields() {
        const role = document.getElementById('login-role').value;
        const visitorFields = document.getElementById('visitor-login-fields');
        const adminFields = document.getElementById('admin-login-fields');

        if (role === 'visitor') {
            visitorFields.classList.remove('hidden');
            adminFields.classList.add('hidden');
        } else {
            visitorFields.classList.add('hidden');
            adminFields.classList.remove('hidden');
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        
        const name = document.getElementById('register-name').value;
        const phone = document.getElementById('register-phone').value;

        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, phone })
            });

            const data = await response.json();

            if (response.ok) {
                showToast('Inscription réussie', 'Vous pouvez maintenant vous connecter', 'success');
                switchAuthTab('login');
                document.getElementById('login-phone').value = phone;
            } else {
                showToast('Erreur d\'inscription', data.message || 'Erreur inconnue', 'error');
            }
        } catch (error) {
            showToast('Erreur', 'Impossible de se connecter au serveur', 'error');
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        
        const role = document.getElementById('login-role').value;

        if (role === 'admin') {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            if (username === 'gt' && password === '55436') {
                currentUser = 'admin';
                localStorage.setItem('userRole', 'admin');
            } else {
                showToast('Accès refusé', 'Identifiants administrateur incorrects', 'error');
                return;
            }
        } else {
            const phone = document.getElementById('login-phone').value;

            if (!phone) {
                showToast('Erreur', 'Veuillez entrer votre numéro de téléphone', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUser = 'visitor';
                    localStorage.setItem('userRole', 'visitor');
                    localStorage.setItem('userName', data.name);
                    localStorage.setItem('userPhone', phone);
                } else {
                    showToast('Accès refusé', 'Numéro de téléphone non reconnu', 'error');
                    return;
                }
            } catch (error) {
                showToast('Erreur', 'Impossible de se connecter au serveur', 'error');
                return;
            }
        }

        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-layout').classList.remove('hidden');
        await initApp();
        showToast('Connexion réussie', `Bienvenue en mode ${currentUser === 'admin' ? 'Administrateur' : 'Visiteur'}`, 'success');
    }

    function quickFill(role) {
        if (role === 'admin') {
            document.getElementById('login-role').value = 'admin';
            toggleLoginFields();
            document.getElementById('admin-username').value = 'gt';
            document.getElementById('admin-password').value = '55436';
            switchAuthTab('login');
        } else {
            document.getElementById('login-role').value = 'visitor';
            toggleLoginFields();
            document.getElementById('login-phone').value = '+243000000000';
            switchAuthTab('login');
        }
    }

    // ============================================
    // FONCTIONS API
    // ============================================
    async function loadMenuData() {
        try {
            const response = await fetch(`${API_BASE_URL}/products`);
            if (response.ok) {
                menuData = await response.json();
            }
        } catch (error) {
            console.error('Erreur chargement menu:', error);
        }
    }

    async function loadOrders() {
        try {
            const response = await fetch(`${API_BASE_URL}/orders`);
            if (response.ok) {
                orders = await response.json();
            }
        } catch (error) {
            console.error('Erreur chargement commandes:', error);
        }
    }

    async function loadVisitorOrders() {
        if (currentUser !== 'visitor') return;
        
        try {
            const phone = localStorage.getItem('userPhone');
            const response = await fetch(`${API_BASE_URL}/orders/user/${phone}`);
            if (response.ok) {
                visitorOrders = await response.json();
            }
        } catch (error) {
            console.error('Erreur chargement commandes visiteur:', error);
        }
    }

    // ============================================
    // SYSTEME DE MODAL POPUP
    // ============================================
    function showPopup(title, message, type = 'info', confirmText = 'Confirmer', cancelText = 'Annuler', onConfirm = null, data = null) {
        const modal = document.getElementById('popup-modal');
        const icon = document.getElementById('popup-icon');
        const titleEl = document.getElementById('popup-title');
        const messageEl = document.getElementById('popup-message');
        const confirmBtn = document.getElementById('popup-confirm');
        const cancelBtn = document.getElementById('popup-cancel');
        
        titleEl.innerText = title;
        messageEl.innerText = message;
        confirmBtn.innerText = confirmText;
        cancelBtn.innerText = cancelText;
        popupCallback = onConfirm;
        popupData = data;
        
        // Configuration de l'icône selon le type
        icon.innerHTML = '';
        let iconColor = '';
        
        switch(type) {
            case 'success':
                iconColor = 'bg-emerald-500/20 text-emerald-500';
                icon.innerHTML = '<i class="fas fa-check-circle text-2xl"></i>';
                break;
            case 'warning':
                iconColor = 'bg-amber-500/20 text-amber-500';
                icon.innerHTML = '<i class="fas fa-exclamation-triangle text-2xl"></i>';
                break;
            case 'error':
                iconColor = 'bg-rose-500/20 text-rose-500';
                icon.innerHTML = '<i class="fas fa-times-circle text-2xl"></i>';
                break;
            case 'info':
            default:
                iconColor = 'bg-blue-500/20 text-blue-500';
                icon.innerHTML = '<i class="fas fa-info-circle text-2xl"></i>';
        }
        
        icon.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${iconColor}`;
        modal.classList.remove('hidden');
    }

    function hidePopup() {
        document.getElementById('popup-modal').classList.add('hidden');
        popupCallback = null;
        popupData = null;
    }

    function popupConfirmAction() {
        if (popupCallback) popupCallback(popupData);
        hidePopup();
    }

    // ============================================
    // SYSTEME DE NOTIFICATIONS TOAST
    // ============================================
    function showToast(title, message, type = 'info') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toast-icon');
        const titleEl = document.getElementById('toast-title');
        const messageEl = document.getElementById('toast-message');
        
        titleEl.innerText = title;
        messageEl.innerText = message;
        
        // Configuration de l'icône selon le type
        icon.innerHTML = '';
        let iconColor = '';
        
        switch(type) {
            case 'success':
                iconColor = 'bg-emerald-500/20 text-emerald-500';
                icon.innerHTML = '<i class="fas fa-check-circle"></i>';
                break;
            case 'error':
                iconColor = 'bg-rose-500/20 text-rose-500';
                icon.innerHTML = '<i class="fas fa-times-circle"></i>';
                break;
            default:
                iconColor = 'bg-blue-500/20 text-blue-500';
                icon.innerHTML = '<i class="fas fa-info-circle"></i>';
        }
        
        icon.className = `w-10 h-10 rounded-full flex items-center justify-center mr-3 ${iconColor}`;
        
        toast.classList.remove('translate-x-full');
        setTimeout(() => {
            toast.classList.add('translate-x-full');
        }, 3000);
    }

    // ============================================
    // FONCTIONS PRINCIPALES
    // ============================================
    function logout() {
        showPopup('Déconnexion', 'Voulez-vous vraiment quitter l\'établissement ?', 'warning', 'Quitter', 'Rester', () => {
            currentUser = null;
            cart = [];
            localStorage.clear();
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-layout').classList.add('hidden');
            showToast('Déconnexion', 'Vous avez quitté l\'établissement', 'info');
        });
    }

    async function initApp() {
        await loadMenuData();
        await loadOrders();
        await loadVisitorOrders();
        
        const nav = document.getElementById('nav-menu');
        const userLabel = document.getElementById('user-role-label');
        const userName = document.getElementById('user-display-name');
        const userAvatar = document.getElementById('user-avatar');
        const mobileBtn = document.getElementById('mobile-cart-btn');

        if (currentUser === 'admin') {
            userName.innerText = "Directeur Opulence";
            userLabel.innerText = "Administrateur";
            userAvatar.src = "https://api.dicebear.com/7.x/avataaars/svg?seed=Admin";
            mobileBtn.classList.add('hidden');
            nav.innerHTML = `
                <div onclick="navigate('admin-dash')" class="nav-btn sidebar-item flex items-center space-x-3 px-4 py-3 rounded-2xl cursor-pointer text-zinc-400">
                    <i class="fas fa-tachometer-alt w-5 text-center"></i>
                    <span class="font-bold text-sm">Tableau de Bord</span>
                </div>
                <div onclick="navigate('admin-inv')" class="nav-btn sidebar-item flex items-center space-x-3 px-4 py-3 rounded-2xl cursor-pointer text-zinc-400">
                    <i class="fas fa-boxes w-5 text-center"></i>
                    <span class="font-bold text-sm">Inventaire</span>
                </div>
                <div onclick="navigate('admin-orders')" class="nav-btn sidebar-item flex items-center space-x-3 px-4 py-3 rounded-2xl cursor-pointer text-zinc-400">
                    <i class="fas fa-clipboard-list w-5 text-center"></i>
                    <span class="font-bold text-sm">Commandes</span>
                </div>
                <div onclick="navigate('admin-finance')" class="nav-btn sidebar-item flex items-center space-x-3 px-4 py-3 rounded-2xl cursor-pointer text-zinc-400">
                    <i class="fas fa-chart-line w-5 text-center"></i>
                    <span class="font-bold text-sm">Comptabilité</span>
                </div>
                <div onclick="navigate('admin-menu')" class="nav-btn sidebar-item flex items-center space-x-3 px-4 py-3 rounded-2xl cursor-pointer text-zinc-400">
                    <i class="fas fa-edit w-5 text-center"></i>
                    <span class="font-bold text-sm">Editer Menu</span>
                </div>
            `;
            navigate('admin-dash');
        } else {
            const storedName = localStorage.getItem('userName') || "Client Privilège";
            userName.innerText = storedName;
            userLabel.innerText = "Visiteur";
            userAvatar.src = "https://api.dicebear.com/7.x/avataaars/svg?seed=" + storedName;
            mobileBtn.classList.remove('hidden');
            nav.innerHTML = `
                <div onclick="navigate('visitor-home')" class="nav-btn sidebar-item flex items-center space-x-3 px-4 py-3 rounded-2xl cursor-pointer text-zinc-400">
                    <i class="fas fa-utensils w-5 text-center"></i>
                    <span class="font-bold text-sm">La Carte</span>
                </div>
                <div onclick="navigate('visitor-orders')" class="nav-btn sidebar-item flex items-center space-x-3 px-4 py-3 rounded-2xl cursor-pointer text-zinc-400">
                    <i class="fas fa-history w-5 text-center"></i>
                    <span class="font-bold text-sm">Mes Commandes</span>
                </div>
            `;
            navigate('visitor-home');
        }
        renderRightPanel();
    }

    function navigate(tab) {
        currentTab = tab;
        const display = document.getElementById('content-display');
        const title = document.getElementById('page-title');
        
        // Mise à jour de la navigation UI
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        
        // Trouver et activer l'onglet courant
        const navButtons = document.querySelectorAll('.nav-btn');
        navButtons.forEach((btn, index) => {
            if (currentUser === 'admin') {
                const adminTabs = ['admin-dash', 'admin-inv', 'admin-orders', 'admin-finance', 'admin-menu'];
                if (adminTabs[index] === tab) {
                    btn.classList.add('active');
                }
            } else {
                const visitorTabs = ['visitor-home', 'visitor-orders'];
                if (visitorTabs[index] === tab) {
                    btn.classList.add('active');
                }
            }
        });

        if(window.innerWidth < 1024) toggleSidebar(false);

        switch(tab) {
            case 'admin-dash': 
                title.innerText = "Tableau de Bord";
                renderAdminDash(display); break;
            case 'admin-inv': 
                title.innerText = "Inventaire";
                renderAdminInv(display); break;
            case 'admin-orders': 
                title.innerText = "Suivi Commandes";
                renderAdminOrders(display); break;
            case 'admin-finance': 
                title.innerText = "Comptabilité";
                renderAdminFinance(display); break;
            case 'admin-menu': 
                title.innerText = "Editer Menu";
                renderAdminMenuEdit(display); break;
            case 'visitor-home': 
                title.innerText = "Menu Gastronomique";
                renderVisitorHome(display); break;
            case 'visitor-orders': 
                title.innerText = "Mes Commandes";
                renderVisitorOrders(display); break;
        }
    }

    // ============================================
    // FONCTIONS DE RENDU
    // ============================================
    function renderVisitorHome(container) {
        container.innerHTML = `
            <div class="flex space-x-3 mb-10 overflow-x-auto pb-4 custom-scrollbar no-scrollbar">
                ${categories.map(cat => `
                    <button onclick="setCategory('${cat.id}')" class="px-6 py-3 rounded-2xl font-bold transition-all whitespace-nowrap flex items-center ${currentCategory === cat.id ? 'bg-rose-600 text-white shadow-lg shadow-rose-600/30' : 'bg-zinc-900 text-zinc-500 hover:text-white'}">
                        <i class="${cat.icon} mr-2"></i>
                        ${cat.name}
                    </button>
                `).join('')}
            </div>
            <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-8">
                <!-- Produits chargés dynamiquement -->
            </div>
        `;
        updateProductGrid();
    }

    function renderVisitorOrders(container) {
        if (visitorOrders.length === 0) {
            container.innerHTML = `
                <div class="text-center py-20">
                    <div class="w-24 h-24 bg-zinc-900 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-box-open text-4xl text-zinc-700"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-3">Aucune commande</h3>
                    <p class="text-zinc-500 max-w-md mx-auto">Vous n'avez pas encore passé de commande. Parcourez notre carte gastronomique pour découvrir nos spécialités.</p>
                    <button onclick="navigate('visitor-home')" class="mt-8 bg-rose-600 hover:bg-rose-700 text-white font-bold px-8 py-4 rounded-2xl transition-all">
                        <i class="fas fa-utensils mr-2"></i> Voir la carte
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-history text-rose-500 mr-3"></i>
                        Historique de vos commandes
                    </h3>
                </div>
                
                ${visitorOrders.map(order => {
                    const statusColor = order.status === 'en cours' ? 'bg-rose-500/10 text-rose-500' : 
                                      order.status === 'terminé' ? 'bg-emerald-500/10 text-emerald-500' : 
                                      'bg-blue-500/10 text-blue-500';
                    
                    return `
                        <div class="glass p-8 rounded-[2.5rem] border-l-4 border-rose-500">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                                <div>
                                    <span class="text-[10px] font-black text-zinc-600 bg-zinc-900 px-3 py-1 rounded-full uppercase mb-2 block">
                                        <i class="fas fa-hashtag mr-1"></i>${order.orderId} • <i class="far fa-clock mr-1"></i>${order.time}
                                    </span>
                                    <h4 class="text-xl font-black text-white mb-2">Commande ${order.orderId}</h4>
                                    <span class="${statusColor} text-[10px] font-black px-3 py-1 rounded-full uppercase">
                                        <i class="fas fa-circle mr-1" style="font-size: 6px;"></i> ${order.status}
                                    </span>
                                </div>
                                <span class="text-2xl font-black text-rose-500 mt-4 sm:mt-0">$${order.total.toFixed(2)}</span>
                            </div>
                            <div class="bg-zinc-900/50 rounded-2xl p-6 mb-6">
                                <p class="text-zinc-400 text-sm mb-2 font-semibold">
                                    <i class="fas fa-list mr-1"></i> Contenu de la commande:
                                </p>
                                <p class="text-white">${order.items.map(item => `${item.product?.name || 'Produit'} x${item.quantity}`).join(', ')}</p>
                            </div>
                            <div class="flex space-x-4">
                                <button onclick="reorder(${order.orderId})" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-3 rounded-2xl transition-all">
                                    <i class="fas fa-redo mr-2"></i> Commander à nouveau
                                </button>
                                <button onclick="showOrderDetails('${order.orderId}')" class="flex-1 bg-rose-600/20 hover:bg-rose-600/30 text-rose-500 font-bold py-3 rounded-2xl transition-all">
                                    <i class="fas fa-info-circle mr-2"></i> Détails
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    function updateProductGrid() {
        const grid = document.getElementById('product-grid');
        if(!grid) return;

        const filtered = menuData.filter(p => {
            const matchCat = currentCategory === 'all' || p.type === currentCategory;
            const matchSearch = p.name.toLowerCase().includes(searchQuery.toLowerCase());
            return matchCat && matchSearch;
        });

        grid.innerHTML = filtered.map(p => {
            const stockPercentage = (p.stock / p.stockMax) * 100;
            let stockColor = 'high';
            if (stockPercentage < 20) stockColor = 'low';
            else if (stockPercentage < 50) stockColor = 'medium';
            
            return `
                <div class="product-card glass p-5 rounded-[2.5rem] flex flex-col relative group">
                    <div class="h-48 w-full rounded-3xl overflow-hidden mb-5 relative bg-zinc-800">
                        <img src="${p.image}" class="w-full h-full object-cover" alt="${p.name}" onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=150&q=80'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                        <div class="absolute bottom-4 left-4">
                            <span class="bg-rose-600 text-white text-[10px] font-black uppercase px-2 py-1 rounded-md tracking-widest">
                                ${p.type === 'repas' ? '<i class="fas fa-utensils mr-1"></i>' : 
                                  p.type === 'boisson' ? '<i class="fas fa-wine-glass mr-1"></i>' : 
                                  p.type === 'dessert' ? '<i class="fas fa-ice-cream mr-1"></i>' : 
                                  '<i class="fas fa-carrot mr-1"></i>'} ${p.type}
                            </span>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold text-white group-hover:text-rose-500 transition-colors">${p.name}</h3>
                            <span class="text-rose-500 font-black text-lg">$${p.price.toFixed(2)}</span>
                        </div>
                        <p class="text-zinc-500 text-xs leading-relaxed mb-4 line-clamp-2">${p.desc}</p>
                        
                        <!-- Indicateur de stock -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-bold text-zinc-500 uppercase">
                                    <i class="fas fa-box mr-1"></i> Stock
                                </span>
                                <span class="text-[10px] font-bold ${stockColor === 'low' ? 'text-rose-500' : stockColor === 'medium' ? 'text-amber-500' : 'text-emerald-500'}">
                                    ${p.stock} unités
                                </span>
                            </div>
                            <div class="w-full bg-zinc-800 rounded-full h-2">
                                <div class="inventory-bar ${stockColor} h-2 rounded-full" style="width: ${stockPercentage}%"></div>
                            </div>
                        </div>
                    </div>
                    <button onclick="addToCart(${p.id})" class="w-full bg-zinc-900 hover:bg-rose-600 text-white py-4 rounded-2xl font-bold flex items-center justify-center transition-all group-hover:shadow-lg group-hover:shadow-rose-600/20 ${p.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${p.stock === 0 ? 'disabled' : ''}>
                        ${p.stock === 0 ? '<i class="fas fa-times-circle mr-2"></i> Rupture de stock' : `
                            <i class="fas fa-plus-circle mr-2"></i> Ajouter
                        `}
                    </button>
                </div>
            `;
        }).join('');
    }

    function renderAdminDash(container) {
        const activeOrders = orders.filter(o => o.status === 'en cours').length;
        const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);
        
        container.innerHTML = `
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-10">
                <div class="glass p-8 rounded-[2.5rem] border-l-4 border-rose-500 shadow-xl">
                    <p class="text-zinc-500 text-xs font-bold uppercase tracking-widest mb-2">
                        <i class="fas fa-money-bill-wave mr-1"></i> Chiffre d'Affaire
                    </p>
                    <h3 class="text-3xl font-black text-white">$${totalRevenue.toFixed(2)}</h3>
                </div>
                <div class="glass p-8 rounded-[2.5rem] border-l-4 border-emerald-500 shadow-xl">
                    <p class="text-zinc-500 text-xs font-bold uppercase tracking-widest mb-2">
                        <i class="fas fa-clipboard-list mr-1"></i> Commandes Actives
                    </p>
                    <h3 class="text-3xl font-black text-white">${activeOrders}</h3>
                </div>
                <div class="glass p-8 rounded-[2.5rem] border-l-4 border-blue-500 shadow-xl">
                    <p class="text-zinc-500 text-xs font-bold uppercase tracking-widest mb-2">
                        <i class="fas fa-boxes mr-1"></i> Produits en Stock
                    </p>
                    <h3 class="text-3xl font-black text-white">${menuData.length}</h3>
                </div>
                <div class="glass p-8 rounded-[2.5rem] border-l-4 border-amber-500 shadow-xl">
                    <p class="text-zinc-500 text-xs font-bold uppercase tracking-widest mb-2">
                        <i class="fas fa-shopping-cart mr-1"></i> Commandes Total
                    </p>
                    <h3 class="text-3xl font-black text-white">${orders.length}</h3>
                </div>
            </div>

            <div class="glass rounded-[2.5rem] overflow-hidden border border-zinc-800 shadow-2xl mb-10">
                <div class="px-8 py-6 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/30">
                    <h3 class="font-bold text-white uppercase tracking-widest text-xs">
                        <i class="fas fa-history mr-2"></i> Commandes Récentes
                    </h3>
                    <button onclick="generateReport()" class="text-rose-500 font-bold text-xs uppercase hover:underline">
                        <i class="fas fa-file-export mr-1"></i> Générer Rapport
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-zinc-500 border-b border-zinc-800">
                            <tr>
                                <th class="px-8 py-4 font-bold uppercase text-[10px]">ID Commande</th>
                                <th class="px-8 py-4 font-bold uppercase text-[10px]">Client</th>
                                <th class="px-8 py-4 font-bold uppercase text-[10px]">Montant</th>
                                <th class="px-8 py-4 font-bold uppercase text-[10px]">Statut</th>
                                <th class="px-8 py-4 font-bold uppercase text-[10px]">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-zinc-900">
                            ${orders.map(order => {
                                const statusColor = order.status === 'en cours' ? 'bg-rose-500/10 text-rose-500' : 
                                                  order.status === 'terminé' ? 'bg-emerald-500/10 text-emerald-500' : 
                                                  'bg-blue-500/10 text-blue-500';
                                return `
                                    <tr>
                                        <td class="px-8 py-6 font-bold text-white">
                                            <i class="fas fa-hashtag mr-2 text-zinc-600"></i>${order.orderId}
                                        </td>
                                        <td class="px-8 py-6 font-bold text-white">${order.customerName}</td>
                                        <td class="px-8 py-6 font-black text-rose-500">$${order.total.toFixed(2)}</td>
                                        <td class="px-8 py-6">
                                            <span class="${statusColor} text-[10px] font-black px-3 py-1 rounded-full uppercase">
                                                <i class="fas fa-circle mr-1" style="font-size: 6px;"></i> ${order.status}
                                            </span>
                                        </td>
                                        <td class="px-8 py-6">
                                            ${order.status === 'en cours' ? `
                                                <button onclick="finishOrder('${order.orderId}')" class="text-emerald-500 hover:text-emerald-400 font-bold text-xs uppercase">
                                                    <i class="fas fa-check-circle mr-1"></i> Terminer
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // Les autres fonctions de rendu (renderAdminInv, renderAdminOrders, renderAdminFinance, renderAdminMenuEdit)
    // restent similaires mais avec des appels API adaptés

    // ============================================
    // FONCTIONS D'ACTION
    // ============================================
    function setCategory(cat) {
        currentCategory = cat;
        renderVisitorHome(document.getElementById('content-display'));
    }

    function setInventoryFilter(filter) {
        inventoryFilter = filter;
        renderAdminInv(document.getElementById('content-display'));
    }

    function searchItems(val) {
        searchQuery = val;
        if(currentTab === 'visitor-home') updateProductGrid();
    }

    function addToCart(id) {
        const item = menuData.find(i => i.id === id);
        if(item.stock <= 0) {
            showToast('Rupture de stock', `${item.name} n'est plus disponible`, 'error');
            return;
        }
        
        cart.push({...item});
        renderRightPanel();
        updateMobileCartUI();
        
        // Animation de feedback
        const btn = document.getElementById('cart-count-badge');
        btn.classList.add('scale-125');
        setTimeout(() => btn.classList.remove('scale-125'), 200);
        
        showToast('Ajouté au panier', `${item.name} a été ajouté à votre commande`, 'success');
    }

    async function confirmOrder() {
        if(cart.length === 0) {
            showToast('Panier vide', 'Votre panier est vide', 'error');
            return;
        }
        
        const total = cart.reduce((a, b) => a + b.price, 0);
        const userPhone = localStorage.getItem('userPhone');
        const userName = localStorage.getItem('userName');
        
        const orderData = {
            customerPhone: userPhone,
            customerName: userName,
            items: cart.map(item => ({
                productId: item.id,
                quantity: 1,
                price: item.price
            })),
            total: total,
            status: 'en cours'
        };

        try {
            const response = await fetch(`${API_BASE_URL}/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                const newOrder = await response.json();
                
                // Déduction du stock
                cart.forEach(async item => {
                    await fetch(`${API_BASE_URL}/products/${item.id}/stock`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ change: -1 })
                    });
                });

                showToast('Commande confirmée', `Votre commande ${newOrder.orderId} a été envoyée en cuisine !`, 'success');
                cart = [];
                renderRightPanel();
                updateMobileCartUI();
                
                // Recharger les données
                await loadMenuData();
                await loadOrders();
                await loadVisitorOrders();
                
                if(window.innerWidth < 1024) toggleMobileCart();
                
                if (currentTab === 'visitor-orders') {
                    navigate('visitor-orders');
                }
            } else {
                showToast('Erreur', 'Impossible de passer la commande', 'error');
            }
        } catch (error) {
            showToast('Erreur', 'Impossible de se connecter au serveur', 'error');
        }
    }

    // ============================================
    // INITIALISATION
    // ============================================
    window.addEventListener('DOMContentLoaded', () => {
        // Vérifier si l'utilisateur est déjà connecté
        const userRole = localStorage.getItem('userRole');
        if (userRole) {
            currentUser = userRole;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-layout').classList.remove('hidden');
            initApp();
        }
    });

    window.addEventListener('resize', () => {
        if(window.innerWidth >= 1024) toggleSidebar(false);
    });
</script>
</body>
</html>